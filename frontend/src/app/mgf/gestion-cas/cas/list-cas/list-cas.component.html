<div class="card">
    <div class="card-header bg-default">
        <div class="row">
          <div class="col-sm-8">
            <h2 class="card-title text-white">
              <i class="nc-icon nc-layout-11"></i>
              Gestion des cas
            </h2>
          </div>
          <div class="col-sm-4 text-right mt-2">
            <!-- <button *ngIf="permissions.can_add" mat-raised-button routerLink="edit" class="mr-1" color="info">
              <mat-icon>add</mat-icon>
            </button> -->
            <button mat-raised-button color="primary" (click)="onRefresh()">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
    </div>
    <div class="card-body">
        <app-search-bar [isLoading]="spinner.loadingEvent$ | async" (onSearchEvent)="onSearch($event)"></app-search-bar>
        <hr>
        
        <!-- Spinner -->
        <app-spinner [filterBy]="casUrl" #spinner></app-spinner>

        <div [hidden]="!dataSource || dataSource.data.length === 0">
            <div class="row">
                <div class="col-md-2 label">
                    Total : {{ dataSource.data.length }}
                  </div>
                  <div class="col-md-10 text-right">
                    <button type="button" [class.spinner]="isExporting" [disabled]="isExporting" color="info" mat-raised-button (click)="onExport()">
                      <mat-icon>file_download</mat-icon>
                    </button>
                  </div>
            </div>
            <hr>
            <div class="mat-table-header">
                <!-- Formulaire de recherche de material table -->
                <form [formGroup]="searchForm" class="search__form">
                    <div class="row">
                        <div class="col-md-3">
                            <mat-form-field class="search__form_field" appearance="outline">
                                <mat-label>Code</mat-label>
                                <input type="text" matInput formControlName="code" aria-label="Code" (keyup)="applyFilter()"/>
                            </mat-form-field>
                        </div>
                        <div class="col-md-3">
                            <mat-form-field class="search__form_field" appearance="outline">
                                <mat-label>Type de cas</mat-label>
                                <mat-select formControlName="typeCas" aria-label="Type de cas" (selectionChange)="applyFilter()">
                                    <mat-option value="">Tous</mat-option>
                                    <mat-option *ngFor="let tp of typeCas$ | async" [value]="tp.libelle">{{ tp.libelle }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col-md-3">
                            <mat-form-field class="search__form_field" appearance="outline">
                                <mat-label>Survivant.e (nom, prenom, sexe)</mat-label>
                                <input type="text" matInput formControlName="victime" aria-label="Victime" (keyup)="applyFilter()"/>
                            </mat-form-field>
                        </div>
                        <div class="col-md-3">
                            <mat-form-field class="search__form_field" appearance="outline">
                                <mat-label>Statut</mat-label>
                                <mat-select formControlName="statut" aria-label="Statut" (selectionChange)="applyFilter()">
                                    <mat-option value="">Tous</mat-option>
                                    <mat-option *ngFor="let st of statutCas | keyvalue" [value]="st.value">{{ st.value | statusCasFormat }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                </form>
            </div>
            <div class="mat-table-container mat-elevation-z0">
                <mat-table [dataSource]="dataSource" matSort>
                    <!-- date Column -->
                    <ng-container matColumnDef="date">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Date</mat-header-cell>
                        <mat-cell *matCellDef="let row">{{ row.date | date : 'dd/MM/yyyy' }}</mat-cell>
                    </ng-container>
                    <!-- code Column -->
                    <ng-container matColumnDef="code">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Code</mat-header-cell>
                        <mat-cell *matCellDef="let row">{{ row.code }}</mat-cell>
                    </ng-container>
                    <!-- TypeCas Column -->
                    <ng-container matColumnDef="typeCas">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Type de cas</mat-header-cell>
                        <mat-cell *matCellDef="let row">{{ row.typeCas }}</mat-cell>
                    </ng-container>
                    <!-- victime Column -->
                    <ng-container matColumnDef="victime">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Survivant.e </mat-header-cell>
                        <mat-cell *matCellDef="let row">{{ row.victime }}</mat-cell>
                    </ng-container>
                    <!-- Age Column -->
                    <ng-container matColumnDef="ageVictime">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Age</mat-header-cell>
                        <mat-cell *matCellDef="let row">{{ row.ageVictime + ' ans'}}</mat-cell>
                    </ng-container>
                    <!-- sexe Column -->
                    <ng-container matColumnDef="sexeVictime">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Sexe</mat-header-cell>
                        <mat-cell *matCellDef="let row">{{ row.sexeVictime }}</mat-cell>
                    </ng-container>
                    
                    <!-- alerte Column -->
                    <ng-container matColumnDef="alerte">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Source Alerte</mat-header-cell>
                        <mat-cell *matCellDef="let row" class="bold">{{ row.alerte }}</mat-cell>
                    </ng-container>

                    <!-- localite Column -->
                    <ng-container matColumnDef="localite">
                        <mat-header-cell *matHeaderCellDef  mat-sort-header>Localité</mat-header-cell>
                        <mat-cell *matCellDef="let row">
                            <span *ngIf="row.localite | findLocalite : row.localiteType | async as loc">
                                {{ loc.nom }}
                            </span>
                        </mat-cell>
                    </ng-container>
                    <!-- Statut Column -->
                    <ng-container matColumnDef="statut">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Statut</mat-header-cell>
                        <mat-cell *matCellDef="let row">
                            <button mat-button [color]="row.statut | statusCasFormat : true">{{ row.statut | statusCasFormat }}</button>
                        </mat-cell>
                    </ng-container>
                    <!-- Action Column -->
                    <ng-container matColumnDef="action">
                    <mat-header-cell *matHeaderCellDef> ACTION </mat-header-cell>
                    <mat-cell  *matCellDef="let row">
                        <!-- <button mat-mini-fab color="primary" (click)="gotoEdit(row.id)"
                            aria-label="Modifier" title="Modifier">
                            <mat-icon>edit</mat-icon>
                        </button> -->
                        <button *ngIf="permissions.can_view_info" mat-mini-fab color="info" aria-label="Détail" title="Détail" [routerLink]="['info', row.id]">
                            <mat-icon>visibility</mat-icon>
                        </button>
                        <button *ngIf="permissions.can_delete" mat-mini-fab color="accent" aria-label="Supprimer" title="Supprimer" (click)="onDelete(row.id)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </mat-cell>
                    </ng-container>
                    <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                    <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
                </mat-table>
                
                <mat-paginator #paginator (page)="pageChanged($event)" [length]="totalRows" [pageIndex]="currentPage" [pageSize]="pageSize" [pageSizeOptions]="dataSource.data.length | tableOptions"></mat-paginator>

                <!-- <mat-paginator [pageSize]="10" [pageSizeOptions]="dataSource.data.length | tableOptions" ></mat-paginator> -->
            </div>
        </div>
        <div *ngIf="dataSource.data.length === 0 && ((spinner.loadingEvent$ | async) === false)" class="text-info text-center mt-2">
            Aucun cas trouvé !!!
        </div>
    </div>
</div>
